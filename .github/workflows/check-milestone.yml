name: Add unclassified label to issues and PRs without a milestone

on:
  issues:
    types: [closed]
  pull_request:
    types: [closed]

jobs:
  add-unclassified-label:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Fetch issue or PR details
        id: fetch-details
        run: |
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          ISSUE_OR_PR_NUMBER=${{ github.event.number }}
          API_URL="https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_OR_PR_NUMBER"

          DETAILS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" $API_URL)
          MILESTONE=$(printf '%s' "$DETAILS" | jq -rc '.milestone')
          MERGED=$(printf '%s' "$DETAILS" | jq -rc '.merged')
          echo "milestone<<MULTILINE_DELIMITER
          $MILESTONE
          MULTILINE_DELIMITER" >> $GITHUB_OUTPUT
          echo "merged=$MERGED" >> $GITHUB_OUTPUT
          echo "milestone<<MULTILINE_DELIMITER
          $MILESTONE
          MULTILINE_DELIMITER"
          echo "merged=$MERGED"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Add Unclassified label
        uses: actions-ecosystem/action-add-labels@v1
        if: steps.fetch-details.outputs.milestone == 'null' && (steps.fetch-details.outputs.merged == 'true' || github.event_name == 'issues')
        with:
          labels: unclassified
